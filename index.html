import React, { useState } from 'react';
import { RotateCcw, HelpCircle, Target } from 'lucide-react';

const NumberGuessGame = () => {
  const [answer, setAnswer] = useState(() => Math.floor(Math.random() * 100) + 1);
  const [answersLeft, setAnswersLeft] = useState(5);
  const [hintsUsed, setHintsUsed] = useState(0);
  const [gameState, setGameState] = useState('playing'); // 'playing', 'won', 'lost'
  const [history, setHistory] = useState([]);
  const [wins, setWins] = useState(0);
  const [losses, setLosses] = useState(0);
  const [conditions, setConditions] = useState([]);
  const [selectedAnswer, setSelectedAnswer] = useState('');

  // å…¨æ¡ä»¶ã‚’æº€ãŸã™å€™è£œæ•°ã‚’è¨ˆç®—
  const getCandidates = (conditionsList) => {
    const candidates = [];
    for (let n = 1; n <= 100; n++) {
      let valid = true;
      for (const cond of conditionsList) {
        if (cond.type === 'min' && n < cond.value) valid = false;
        if (cond.type === 'max' && n > cond.value) valid = false;
        if (cond.type === 'even' && n % 2 !== 0) valid = false;
        if (cond.type === 'odd' && n % 2 === 0) valid = false;
        if (cond.type === 'multiple5' && n % 5 !== 0) valid = false;
        if (cond.type === 'notMultiple5' && n % 5 === 0) valid = false;
      }
      if (valid) candidates.push(n);
    }
    return candidates;
  };

  const currentCandidates = getCandidates(conditions);
  const candidateCount = currentCandidates.length;
  const minCandidate = currentCandidates.length > 0 ? Math.min(...currentCandidates) : 1;
  const maxCandidate = currentCandidates.length > 0 ? Math.max(...currentCandidates) : 100;

  const resetGame = () => {
    setAnswer(Math.floor(Math.random() * 100) + 1);
    setAnswersLeft(5);
    setHintsUsed(0);
    setGameState('playing');
    setHistory([]);
    setConditions([]);
    setSelectedAnswer('');
  };

  const addHistory = (text, type) => {
    setHistory(prev => [...prev, { text, type }]);
  };

  const useHint = (hintType, value = null) => {
    if (gameState !== 'playing') return;

    let result = '';
    let newConditions = [...conditions];

    switch (hintType) {
      case 'bigger':
        if (answer > value) {
          result = `ã¯ã„ã€${value}ã‚ˆã‚Šå¤§ãã„ã§ã™`;
          newConditions.push({ type: 'min', value: value + 1 });
        } else {
          result = `ã„ã„ãˆã€${value}ä»¥ä¸‹ã§ã™`;
          newConditions.push({ type: 'max', value: value });
        }
        break;
      case 'smaller':
        if (answer < value) {
          result = `ã¯ã„ã€${value}ã‚ˆã‚Šå°ã•ã„ã§ã™`;
          newConditions.push({ type: 'max', value: value - 1 });
        } else {
          result = `ã„ã„ãˆã€${value}ä»¥ä¸Šã§ã™`;
          newConditions.push({ type: 'min', value: value });
        }
        break;
      case 'even':
        if (answer % 2 === 0) {
          result = 'ã¯ã„ã€å¶æ•°ã§ã™';
          newConditions.push({ type: 'even' });
        } else {
          result = 'ã„ã„ãˆã€å¥‡æ•°ã§ã™';
          newConditions.push({ type: 'odd' });
        }
        break;
      case 'odd':
        if (answer % 2 === 1) {
          result = 'ã¯ã„ã€å¥‡æ•°ã§ã™';
          newConditions.push({ type: 'odd' });
        } else {
          result = 'ã„ã„ãˆã€å¶æ•°ã§ã™';
          newConditions.push({ type: 'even' });
        }
        break;
      case 'multiple5':
        if (answer % 5 === 0) {
          result = 'ã¯ã„ã€5ã®å€æ•°ã§ã™';
          newConditions.push({ type: 'multiple5' });
        } else {
          result = 'ã„ã„ãˆã€5ã®å€æ•°ã§ã¯ã‚ã‚Šã¾ã›ã‚“';
          newConditions.push({ type: 'notMultiple5' });
        }
        break;
      case 'range1-50':
        if (answer <= 50) {
          result = 'ã¯ã„ã€1ã€œ50ã®é–“ã§ã™';
          newConditions.push({ type: 'max', value: 50 });
        } else {
          result = 'ã„ã„ãˆã€51ã€œ100ã®é–“ã§ã™';
          newConditions.push({ type: 'min', value: 51 });
        }
        break;
      case 'range51-100':
        if (answer >= 51) {
          result = 'ã¯ã„ã€51ã€œ100ã®é–“ã§ã™';
          newConditions.push({ type: 'min', value: 51 });
        } else {
          result = 'ã„ã„ãˆã€1ã€œ50ã®é–“ã§ã™';
          newConditions.push({ type: 'max', value: 50 });
        }
        break;
    }

    setConditions(newConditions);
    const newCandidates = getCandidates(newConditions);
    addHistory(`${result}ï¼ˆå€™è£œ: ${newCandidates.length}å€‹ï¼‰`, 'hint');
    setHintsUsed(hintsUsed + 1);
  };

  const submitAnswer = () => {
    if (answersLeft === 0 || gameState !== 'playing' || !selectedAnswer) return;

    const num = parseInt(selectedAnswer);
    if (isNaN(num) || num < 1 || num > 100) {
      addHistory('1ã€œ100ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
      return;
    }

    if (num === answer) {
      addHistory(`ğŸ‰ æ­£è§£ã§ã™ï¼ç­”ãˆã¯ ${answer} ã§ã—ãŸï¼`, 'success');
      setGameState('won');
      setWins(wins + 1);
    } else {
      const remaining = answersLeft - 1;
      if (remaining === 0) {
        addHistory(`âŒ æ®‹å¿µï¼ç­”ãˆã¯ ${answer} ã§ã—ãŸ`, 'error');
        setGameState('lost');
        setLosses(losses + 1);
      } else {
        const hint = num < answer ? 'ã‚‚ã£ã¨å¤§ãã„æ•°ã§ã™' : 'ã‚‚ã£ã¨å°ã•ã„æ•°ã§ã™';
        addHistory(`${num} ã¯ä¸æ­£è§£ã€‚${hint}ï¼ˆæ®‹ã‚Š${remaining}å›ï¼‰`, 'wrong');
        setAnswersLeft(remaining);
      }
    }
    setSelectedAnswer('');
  };

  const getMidValue = () => {
    if (currentCandidates.length === 0) return 50;
    return currentCandidates[Math.floor(currentCandidates.length / 2)];
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
      <div className="max-w-2xl mx-auto">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
          <div className="flex items-center justify-between mb-4">
            <h1 className="text-3xl font-bold text-gray-800">ğŸ¯ æ•°å½“ã¦ã‚²ãƒ¼ãƒ </h1>
            <button
              onClick={resetGame}
              className="flex items-center gap-2 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
            >
              <RotateCcw size={20} />
              ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>

          {/* ã‚¹ã‚³ã‚¢è¡¨ç¤º */}
          <div className="flex gap-4 text-lg font-semibold">
            <div className="text-green-600">å‹ã¡: {wins}</div>
            <div className="text-red-600">è² ã‘: {losses}</div>
          </div>
        </div>

        {/* ã‚²ãƒ¼ãƒ èª¬æ˜ */}
        {history.length === 0 && gameState === 'playing' && (
          <div className="bg-blue-100 rounded-xl p-6 mb-4">
            <h2 className="text-xl font-bold mb-2">ğŸ® ã‚ãã³ã‹ãŸ</h2>
            <p className="text-gray-700 mb-2">1ã€œ100ã®æ•°å­—ã‚’å½“ã¦ã¦ã­ï¼</p>
            <div className="space-y-1 text-sm text-gray-600">
              <p>â€¢ ãƒ’ãƒ³ãƒˆ: <strong>ä½•å›ã§ã‚‚ä½¿ãˆã‚‹ï¼</strong></p>
              <p>â€¢ è§£ç­”æ¨©: {answersLeft}å›</p>
              <p>â€¢ ã˜ã£ãã‚Šè€ƒãˆã¦æ­£è§£ã‚’æ¢ãã†ï¼</p>
            </div>
          </div>
        )}

        {/* ã‚¿ãƒ¼ãƒ³è¡¨ç¤º */}
        {gameState === 'playing' && (
          <div className="bg-white rounded-xl shadow p-4 mb-4">
            <div className="flex justify-between items-center text-lg">
              <div className="flex items-center gap-2">
                <HelpCircle className="text-blue-500" />
                <span>ãƒ’ãƒ³ãƒˆä½¿ç”¨: <strong>{hintsUsed}å›</strong></span>
              </div>
              <div className="flex items-center gap-2">
                <Target className="text-green-500" />
                <span>è§£ç­”æ®‹ã‚Š: <strong>{answersLeft}å›</strong></span>
              </div>
            </div>
            <div className="mt-2 text-sm text-gray-600">
              å€™è£œç¯„å›²: {minCandidate} ã€œ {maxCandidate} ({candidateCount}å€‹)
            </div>
          </div>
        )}

        {/* ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ */}
        {gameState === 'playing' && (
          <div className="bg-white rounded-xl shadow-lg p-6 mb-4">
            <h3 className="text-lg font-bold mb-3">ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’ä½¿ã†ï¼ˆä½•å›ã§ã‚‚OKï¼ï¼‰</h3>
            
            {/* è‡ªç”±å…¥åŠ›ãƒ’ãƒ³ãƒˆ */}
            <div className="mb-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
              <p className="text-sm font-semibold mb-2 text-gray-700">ğŸ¯ å¥½ããªæ•°å­—ã§è³ªå•</p>
              <div className="flex gap-2">
                <input
                  type="number"
                  value={selectedAnswer}
                  onChange={(e) => setSelectedAnswer(e.target.value)}
                  placeholder="æ•°å­—ã‚’å…¥åŠ›"
                  className="flex-1 p-3 text-xl border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  min="1"
                  max="100"
                />
                <button
                  onClick={() => {
                    const num = parseInt(selectedAnswer);
                    if (!isNaN(num) && num >= 1 && num <= 100) {
                      useHint('bigger', num);
                    }
                  }}
                  disabled={!selectedAnswer}
                  className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-bold whitespace-nowrap"
                >
                  ã‚ˆã‚Šå¤§ãã„ï¼Ÿ
                </button>
                <button
                  onClick={() => {
                    const num = parseInt(selectedAnswer);
                    if (!isNaN(num) && num >= 1 && num <= 100) {
                      useHint('smaller', num);
                    }
                  }}
                  disabled={!selectedAnswer}
                  className="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-bold whitespace-nowrap"
                >
                  ã‚ˆã‚Šå°ã•ã„ï¼Ÿ
                </button>
              </div>
            </div>

            {/* ãã®ä»–ã®ãƒ’ãƒ³ãƒˆ */}
            <p className="text-sm font-semibold mb-2 text-gray-700">ğŸ” ãã®ä»–ã®è³ªå•</p>
            <div className="grid grid-cols-2 gap-3">
              <button
                onClick={() => useHint('even')}
                className="p-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-semibold"
              >
                å¶æ•°ï¼Ÿ
              </button>
              <button
                onClick={() => useHint('odd')}
                className="p-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-semibold"
              >
                å¥‡æ•°ï¼Ÿ
              </button>
              <button
                onClick={() => useHint('multiple5')}
                className="p-4 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition text-sm font-semibold"
              >
                5ã®å€æ•°ï¼Ÿ
              </button>
              <button
                onClick={() => useHint('range1-50')}
                className="p-4 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition text-sm font-semibold"
              >
                1ã€œ50ã®é–“ï¼Ÿ
              </button>
            </div>
          </div>
        )}

        {/* è§£ç­”å…¥åŠ› */}
        {gameState === 'playing' && (
          <div className="bg-white rounded-xl shadow-lg p-6 mb-4">
            <h3 className="text-lg font-bold mb-3">ğŸ¯ ç­”ãˆã‚’å…¥åŠ›</h3>
            <div className="flex gap-3">
              <input
                type="number"
                value={selectedAnswer}
                onChange={(e) => setSelectedAnswer(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && submitAnswer()}
                placeholder="1ã€œ100ã®æ•°å­—"
                className="flex-1 p-4 text-2xl border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                min="1"
                max="100"
              />
              <button
                onClick={submitAnswer}
                disabled={answersLeft === 0 || !selectedAnswer}
                className="px-8 py-4 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-bold text-lg"
              >
                è§£ç­”ï¼
              </button>
            </div>
          </div>
        )}

        {/* å±¥æ­´ */}
        {history.length > 0 && (
          <div className="bg-white rounded-xl shadow-lg p-6 mb-4">
            <h3 className="text-lg font-bold mb-3">ğŸ“ å±¥æ­´</h3>
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {history.map((item, index) => (
                <div
                  key={index}
                  className={`p-3 rounded-lg ${
                    item.type === 'hint' ? 'bg-blue-50 text-blue-800' :
                    item.type === 'success' ? 'bg-green-50 text-green-800' :
                    item.type === 'error' ? 'bg-red-50 text-red-800' :
                    'bg-yellow-50 text-yellow-800'
                  }`}
                >
                  {item.text}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* ãƒªã‚¶ãƒ«ãƒˆ */}
        {gameState !== 'playing' && (
          <div className={`rounded-xl shadow-lg p-8 text-center ${
            gameState === 'won' ? 'bg-green-100' : 'bg-red-100'
          }`}>
            <div className="text-6xl mb-4">{gameState === 'won' ? 'ğŸ‰' : 'ğŸ˜¢'}</div>
            <h2 className="text-3xl font-bold mb-4">
              {gameState === 'won' ? 'ã‚¯ãƒªã‚¢ï¼' : 'ã–ã‚“ã­ã‚“...'}
            </h2>
            <p className="text-xl mb-2">
              {gameState === 'won' 
                ? `ãƒ’ãƒ³ãƒˆ ${hintsUsed}å›ã§æ­£è§£ï¼`
                : 'æ¬¡ã¯ãŒã‚“ã°ã‚ã†ï¼'
              }
            </p>
            {gameState === 'won' && (
              <p className="text-gray-600 mb-6">
                {hintsUsed <= 7 ? 'ç´ æ™´ã‚‰ã—ã„è³ªå•åŠ›ã§ã™ï¼ğŸŒŸ' :
                 hintsUsed <= 10 ? 'ã‚ˆãè€ƒãˆã¦å½“ã¦ã‚‰ã‚Œã¾ã—ãŸã­ï¼ğŸ‘' :
                 'ãŒã‚“ã°ã‚Šã¾ã—ãŸï¼æ¬¡ã¯ã‚‚ã£ã¨å°‘ãªã„ãƒ’ãƒ³ãƒˆã§å½“ã¦ã¦ã¿ã‚ˆã†ï¼ğŸ’ª'}
              </p>
            )}
            <button
              onClick={resetGame}
              className="px-8 py-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-bold text-lg"
            >
              ã‚‚ã†ä¸€åº¦ã‚ãã¶
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default NumberGuessGame;
